<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast Match ‚Äî Voice + Text (FINAL)</title>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg1:#07131f; --bg2:#0b2a3a;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --a:#00f2fe; --b:#4facfe;
      --ok:#26e6a7; --bad:#ff5a7a; --warn:#ffcf5a;
      --r:18px; --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 20% 10%, #123a55 0%, transparent 55%),
        radial-gradient(900px 600px at 80% 15%, #1a2f6b 0%, transparent 52%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--txt);
      display:flex;justify-content:center;align-items:center;
      padding:14px;
    }
    .app{
      width:min(1120px,100%);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }
    .brand{display:flex;align-items:center;gap:12px;user-select:none}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--a),var(--b));
      display:grid;place-items:center;
      font-weight:900;color:#001018;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(79,172,254,.20);
    }
    .brand h1{font-size:16px;line-height:1.1}
    .brand p{font-size:12px;color:var(--muted)}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 6px rgba(255,207,90,.14)}
    .dot.on{background:var(--ok);box-shadow:0 0 0 6px rgba(38,230,167,.14)}

    .content{
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
      padding:14px;
    }
    @media(max-width: 980px){ .content{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r);
      padding:14px;
    }
    .card h2{font-size:13px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .small{font-size:12px;color:var(--muted);line-height:1.45}

    .levels{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width: 430px){ .levels{grid-template-columns: repeat(3, 1fr)} }
    .level{
      padding:12px 0;border-radius:14px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      text-align:center;font-weight:900;
      cursor:pointer;transition:.2s;
    }
    .level:hover{transform:translateY(-2px);background:rgba(255,255,255,.11)}
    .level.active{background:linear-gradient(135deg,var(--a),var(--b));color:#001018;border-color:transparent}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:none;cursor:pointer;border-radius:16px;
      padding:12px 14px;font-weight:900;font-size:14px;
      transition:.2s;display:flex;align-items:center;gap:10px;
    }
    .primary{background:linear-gradient(135deg,var(--a),var(--b));color:#001018}
    .primary:hover{transform:scale(1.03)}
    .ghost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:var(--txt)}
    .ghost:hover{background:rgba(255,255,255,.12)}
    .danger{background:rgba(255,90,122,.14);border:1px solid rgba(255,90,122,.35);color:#ffd7df}
    .danger:hover{background:rgba(255,90,122,.20)}

    .status{
      margin-top:12px;padding:12px;border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      font-size:12px;color:var(--muted);line-height:1.45;
    }

    .stage{
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12px;
      min-height:560px;
    }
    .tags{display:flex;gap:10px;flex-wrap:wrap}
    .tag{
      font-size:12px;padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);
    }
    .tag b{color:#fff}

    .panels{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width: 980px){ .stage{min-height:700px} .panels{grid-template-columns:1fr} }

    .panel{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:12px;
      display:flex;flex-direction:column;
      min-height: 320px;
    }
    .panel h3{font-size:13px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .meter{
      flex:1;min-width:220px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.10);overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--a),var(--b));transition:width .2s}
    audio{width:100%}

    .chatBox{
      flex:1;overflow:auto;border-radius:14px;padding:10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .msg{
      max-width:85%;margin:8px 0;padding:10px 12px;border-radius:14px;
      font-size:12px;line-height:1.35;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      white-space:pre-wrap;word-break:break-word;
    }
    .me{margin-left:auto;background:rgba(0,242,254,.10);border-color:rgba(0,242,254,.25)}
    .meta{opacity:.7;font-size:10px;margin-top:4px}
    .chatInputRow{display:flex;gap:10px;margin-top:10px}
    input[type="text"]{
      flex:1;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.55)}
    .sendBtn{
      padding:12px 14px;border-radius:14px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;font-weight:900;
    }
    .sendBtn:hover{background:rgba(255,255,255,.14)}

    /* OPEN screen */
    #openScreen{
      position:fixed;inset:0;
      background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      display:flex;align-items:center;justify-content:center;
      z-index:9999;padding:18px;
    }
    .openCard{
      width:min(520px,100%);
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:22px;text-align:center;
    }
    .openTitle{font-size:34px;font-weight:1000;letter-spacing:.3px}
    .openSub{margin-top:8px;color:rgba(255,255,255,.78);font-size:13px;line-height:1.5}
    .openBtn{margin-top:18px;width:100%;justify-content:center;padding:16px 18px;font-size:16px}
    .hidden{display:none !important;}
  </style>
</head>
<body>

<div id="openScreen">
  <div class="openCard">
    <div class="openTitle">üé§ Fast Match</div>
    <div class="openSub">
      Find bosilganda: <b>Qidirilyapti ‚Üí Topildi ‚Üí Gaplashish</b><br>
      Voice + Text ikkalasi ham bor.
    </div>
    <button class="primary openBtn" id="openBtn">üöÄ OPEN</button>
    <div class="openSub" style="margin-top:10px;opacity:.85">
      Admin online count (faqat sen): logo 5 marta ‚Üí kod: <b>2332</b>
    </div>
  </div>
</div>

<div class="app" id="mainApp" style="display:none;">
  <div class="top">
    <div class="brand">
      <div class="logo" id="logo">SZ</div>
      <div>
        <h1>Fast Match ‚Ä¢ Voice + Text</h1>
        <p>Find ‚Üí Qidirilyapti ‚Üí Topildi ‚Üí Gaplashish</p>
      </div>
    </div>
    <div class="pill">
      <span class="dot" id="dot"></span>
      <span id="netText">Ulanmadi</span>
      <span id="adminOnline" class="hidden">‚Ä¢ Online: <b id="onlineCount">0</b></span>
    </div>
  </div>

  <div class="content">
    <div class="card">
      <h2>1) Level tanlang <span class="small" id="picked">‚Äî</span></h2>
      <div class="small">Bir xil leveldagi odam bo‚Äòlsa tezda topadi. Yo‚Äòq bo‚Äòlsa qidirishda turadi.</div>

      <div class="levels">
        <div class="level">A1</div><div class="level">A2</div><div class="level">B1</div>
        <div class="level">B2</div><div class="level">C1</div><div class="level">C2</div>
      </div>

      <div class="btns">
        <button class="primary" id="findBtn">üîç Find Partner</button>
        <button class="ghost" id="muteBtn" disabled>üîá Mute</button>
        <button class="danger" id="skipBtn" disabled>‚è≠ Skip</button>
        <button class="danger" id="stopBtn">‚õî Stop</button>
      </div>

      <div class="status" id="status">Level tanlang. Keyin ‚ÄúFind Partner‚Äù.</div>
    </div>

    <div class="stage card">
      <div class="tags">
        <div class="tag">Level: <b id="levelTag">‚Äî</b></div>
        <div class="tag">Room: <b id="roomTag">‚Äî</b></div>
        <div class="tag">Status: <b id="callTag">Idle</b></div>
        <div class="tag">Partner: <b id="peerTag">‚Äî</b></div>
      </div>

      <div class="panels">
        <div class="panel">
          <h3>üéß Voice (Audio-only) <span class="small" id="micState">Mic: off</span></h3>
          <div class="row"><div class="meter"><div class="bar" id="micBar"></div></div></div>
          <div style="height:10px"></div>
          <audio id="remoteAudio" autoplay playsinline></audio>
          <div class="small" style="margin-top:8px;opacity:.8">Topilganda avtomatik voice boshlanadi.</div>
        </div>

        <div class="panel">
          <h3>üí¨ Text Chat <span class="small" id="chatInfo">Room kerak</span></h3>
          <div class="chatBox" id="chatBox"></div>
          <div class="chatInputRow">
            <input id="chatInput" type="text" placeholder="Xabar yozing..." disabled />
            <button class="sendBtn" id="sendBtn" disabled>Send</button>
          </div>
          <div class="small" style="margin-top:8px;opacity:.8">Gaplashishni xohlamaganlar shu yerda yozishadi.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* OPEN */
openBtn.onclick = () => { openScreen.style.display="none"; mainApp.style.display="block"; };

/* üî• Firebase config (TO‚ÄòLDIR) */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* Helpers */
const $ = (id)=>document.getElementById(id);
let uid = "u_" + Math.random().toString(36).slice(2);
let level = null;

let connected = false;
let searching = false;
let roomId = null;
let peerId = null;

let localStream = null;
let pc = null;
let isMuted = false;

let searchLoop = null;
let cleanLoop = null;
let unsub = [];

function setStatus(html){ $("status").innerHTML = html; }
function setNet(ok){
  $("dot").classList.toggle("on", !!ok);
  $("netText").textContent = ok ? "Online" : "Ulanmadi";
}
function on(ref, ev, fn){ ref.on(ev, fn); unsub.push(()=>ref.off(ev, fn)); }
function offAll(){ unsub.forEach(f=>{try{f()}catch(e){}}); unsub=[]; }
function stopLoops(){ if(searchLoop){clearInterval(searchLoop);searchLoop=null;} if(cleanLoop){clearInterval(cleanLoop);cleanLoop=null;} }
function nowTime(){ return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }
function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

function addMsg(text, who){
  const box = $("chatBox");
  const d = document.createElement("div");
  d.className = "msg" + (who==="me" ? " me" : "");
  d.innerHTML = `<div>${esc(text)}</div><div class="meta">${who==="me"?"You":"Partner"} ‚Ä¢ ${nowTime()}</div>`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

/* Admin view */
let clicks=0;
$("logo").addEventListener("click", ()=>{
  clicks++;
  if(clicks>=5){
    clicks=0;
    const code = prompt("Admin kod?");
    if(code==="2332"){ localStorage.setItem("admin_view","1"); location.reload(); }
    else alert("Noto‚Äòg‚Äòri kod");
  }
});

/* Presence + Correct Online Count (only active in last 45s) */
function setupPresence(){
  const connectedRef = db.ref(".info/connected");
  on(connectedRef, "value", (snap)=>{
    connected = snap.val()===true;
    setNet(connected);

    if(connected){
      const meRef = db.ref("presence/"+uid);
      meRef.onDisconnect().remove();
      meRef.set({ ts: Date.now(), level: level || "‚Äî" });

      const hb = setInterval(()=> meRef.update({ ts: Date.now(), level: level || "‚Äî" }), 15000);
      unsub.push(()=> clearInterval(hb));
    } else {
      setStatus("‚ùå Firebase ulanmagan. databaseURL va Rules tekshiring.");
    }
  });

  const adminEnabled = localStorage.getItem("admin_view")==="1";
  if(adminEnabled){
    $("adminOnline").classList.remove("hidden");
    const pres = db.ref("presence");
    on(pres, "value", (snap)=>{
      const v = snap.val() || {};
      const now = Date.now();
      const active = Object.values(v).filter(x => x && x.ts && (now - x.ts) <= 45000).length;
      $("onlineCount").textContent = active;
    });
  }
}
setupPresence();

/* Level select */
document.querySelectorAll(".level").forEach(el=>{
  el.addEventListener("click", ()=>{
    document.querySelectorAll(".level").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    level = el.textContent.trim();
    $("picked").textContent = level;
    $("levelTag").textContent = level;
    db.ref("presence/"+uid).update({ level }).catch(()=>{});
    setStatus(`‚úÖ Level: <b>${level}</b>. Endi ‚ÄúFind Partner‚Äù bosing.`);
  });
});

/* WebRTC Audio */
const rtcConfig = { iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}] };

async function startMic(){
  if(localStream) return localStream;
  localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:false});
  $("micState").textContent = "Mic: on";
  monitorMic(localStream);
  return localStream;
}
function stopMic(){
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
  $("micState").textContent = "Mic: off";
  $("micBar").style.width = "0%";
}
function monitorMic(stream){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const src = ac.createMediaStreamSource(stream);
    const an = ac.createAnalyser();
    an.fftSize=256; src.connect(an);
    const data = new Uint8Array(an.frequencyBinCount);
    let alive=true;
    unsub.push(()=>{ alive=false; try{ac.close()}catch(e){} });
    const loop=()=>{
      if(!alive) return;
      an.getByteFrequencyData(data);
      let sum=0; for(let i=0;i<data.length;i++) sum+=data[i];
      const avg=sum/data.length;
      const pct=Math.min(100, Math.max(0, (avg/255)*120));
      $("micBar").style.width = pct.toFixed(0)+"%";
      requestAnimationFrame(loop);
    };
    loop();
  }catch(e){}
}

function closePeer(){
  if(pc){ try{pc.close()}catch(e){} pc=null; }
  $("remoteAudio").srcObject=null;
  $("callTag").textContent="Idle";
  $("peerTag").textContent="‚Äî";
  $("roomTag").textContent="‚Äî";
  $("chatInfo").textContent="Room kerak";
  $("chatInput").disabled=true;
  $("sendBtn").disabled=true;
  $("muteBtn").disabled=true;
  $("skipBtn").disabled=true;
  isMuted=false;
  $("muteBtn").textContent="üîá Mute";
}
async function initPC(){
  pc = new RTCPeerConnection(rtcConfig);
  const stream = await startMic();
  stream.getTracks().forEach(t=>pc.addTrack(t, stream));
  pc.ontrack = (e)=> $("remoteAudio").srcObject = e.streams[0];
  pc.onconnectionstatechange = ()=> $("callTag").textContent = pc.connectionState;
}
function sig(room){ return db.ref("signal/"+room); }

async function caller(){
  await initPC();
  const s=sig(roomId);
  const myCand=s.child("candidates").child(uid);
  pc.onicecandidate=(e)=>{ if(e.candidate) myCand.push(e.candidate.toJSON()); };

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await s.child("offer").set({type:offer.type,sdp:offer.sdp,from:uid});

  on(s.child("answer"),"value", async (snap)=>{
    const a=snap.val();
    if(a && pc && !pc.currentRemoteDescription) await pc.setRemoteDescription(new RTCSessionDescription(a));
  });

  on(s.child("candidates").child(peerId),"child_added", async (snap)=>{
    const c=snap.val(); if(c) try{ await pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){}
  });
}
async function callee(){
  await initPC();
  const s=sig(roomId);
  const myCand=s.child("candidates").child(uid);
  pc.onicecandidate=(e)=>{ if(e.candidate) myCand.push(e.candidate.toJSON()); };

  on(s.child("offer"),"value", async (snap)=>{
    const o=snap.val();
    if(!o || !pc || pc.currentRemoteDescription) return;
    await pc.setRemoteDescription(new RTCSessionDescription(o));
    const ans=await pc.createAnswer();
    await pc.setLocalDescription(ans);
    await s.child("answer").set({type:ans.type,sdp:ans.sdp,from:uid});
  });

  on(s.child("candidates").child(peerId),"child_added", async (snap)=>{
    const c=snap.val(); if(c) try{ await pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){}
  });
}

/* Matchmaking FAST + VERY CLEAR statuses */
function qMe(){ return db.ref(`queue/${level}/${uid}`); }
function qLvl(){ return db.ref(`queue/${level}`); }
function room(id){ return db.ref(`rooms/${id}`); }

async function ensureQueue(){
  await qMe().set({ts:Date.now(), alive:Date.now(), claimedBy:null, matchedRoom:null});
  qMe().onDisconnect().remove();
}
async function cleanupDead(maxAge=45000){
  const snap=await qLvl().once("value");
  const v=snap.val()||{};
  const now=Date.now();
  const updates={};
  for(const [id,obj] of Object.entries(v)){
    const t=(obj && (obj.alive||obj.ts))||0;
    if(now-t>maxAge) updates[`queue/${level}/${id}`]=null;
  }
  if(Object.keys(updates).length) await db.ref().update(updates);
}

async function fastFind(){
  if(!connected){
    setStatus("‚ùå Firebase ulanmagan. databaseURL / Rules tekshiring.");
    return;
  }
  if(!level){ alert("Level tanlang!"); return; }
  if(searching) return;

  searching=true;
  setStatus(`üîé <b>${level}</b> uchun <b>qidirilyapti...</b>`);
  $("callTag").textContent="Searching";
  $("chatBox").innerHTML="";
  $("chatInfo").textContent="Qidirilyapti...";

  await ensureQueue();

  // alive heartbeat
  const aliveTimer=setInterval(()=> qMe().update({alive:Date.now()}).catch(()=>{}), 8000);
  unsub.push(()=>clearInterval(aliveTimer));

  // if matchedRoom comes, join immediately
  on(qMe().child("matchedRoom"), "value", async (snap)=>{
    const r=snap.val();
    if(r && searching){
      roomId=r;
      searching=false;
      stopLoops();
      await joinRoomAndStart();
    }
  });

  cleanLoop=setInterval(()=>{ if(searching) cleanupDead().catch(()=>{}); }, 7000);

  searchLoop=setInterval(async ()=>{
    if(!searching) return;

    const snap=await qLvl().orderByChild("ts").limitToFirst(30).once("value");
    const list=snap.val()||{};
    const ids=Object.keys(list).filter(x=>x!==uid);

    for(const otherId of ids){
      const node=list[otherId];
      if(!node || node.matchedRoom) continue;

      const claimRef=db.ref(`queue/${level}/${otherId}/claimedBy`);
      const res=await claimRef.transaction(cur => (cur===null?uid:undefined));

      if(res.committed){
        const a=[uid, otherId].sort();
        roomId=`r_${level}_${a[0]}_${a[1]}`;
        peerId=otherId;

        // TOPILDI status (aniq)
        setStatus(`‚úÖ <b>Topildi!</b> Ulanmoqda...`);
        $("callTag").textContent="Connecting";

        const updates={};
        updates[`rooms/${roomId}`]={level,createdAt:Date.now(),users:{[uid]:true,[otherId]:true},endedBy:null};
        updates[`queue/${level}/${uid}/matchedRoom`]=roomId;
        updates[`queue/${level}/${otherId}/matchedRoom`]=roomId;
        await db.ref().update(updates);

        searching=false;
        stopLoops();
        await joinRoomAndStart();
        return;
      }
    }
  }, 350);
}

async function joinRoomAndStart(){
  $("roomTag").textContent=roomId;
  $("chatInfo").textContent="Ulandi";
  $("chatInput").disabled=false;
  $("sendBtn").disabled=false;
  $("skipBtn").disabled=false;
  $("muteBtn").disabled=false;

  // remove my queue
  qMe().remove().catch(()=>{});

  const rSnap=await room(roomId).once("value");
  const r=rSnap.val();
  if(!r || !r.users){
    setStatus("‚ùå Room yo‚Äòq. Qayta Find bosing.");
    return resetAll(false);
  }
  const users=Object.keys(r.users);
  peerId = users.find(x=>x!==uid) || peerId;
  $("peerTag").textContent = peerId ? peerId.slice(0,8) : "‚Äî";

  // endedBy listener
  on(room(roomId).child("endedBy"), "value", (snap)=>{
    const v=snap.val();
    if(v && v!==uid){
      setStatus("‚õî Partner skip qildi. Yana Find bosing.");
      resetAll(false);
    }
  });

  // deterministic caller
  const amCaller = peerId ? ([uid, peerId].sort()[0]===uid) : true;

  try{
    if(amCaller){ $("callTag").textContent="Caller"; await caller(); }
    else { $("callTag").textContent="Callee"; await callee(); }

    // FINAL READY status (aniq)
    setStatus("‚úÖ <b>Topildi!</b> üéß <b>Gaplashishni boshlang</b> (voice tayyor).");
  }catch(e){
    setStatus("‚ùå Voice ulanish xato. Skip bosing va qayta urinib ko‚Äòring.");
  }

  // text chat listener
  on(db.ref(`rooms/${roomId}/messages`), "child_added", (snap)=>{
    const m=snap.val();
    if(!m || !m.text) return;
    addMsg(m.text, (m.user===uid) ? "me" : "peer");
  });
}

/* Text send */
$("sendBtn").onclick = async ()=>{
  const v=$("chatInput").value.trim();
  if(!v || !roomId) return;
  $("chatInput").value="";
  await db.ref(`rooms/${roomId}/messages`).push({user:uid,text:v,ts:Date.now()});
};
$("chatInput").addEventListener("keydown",(e)=>{ if(e.key==="Enter") $("sendBtn").click(); });

/* Buttons */
$("findBtn").onclick = fastFind;

$("muteBtn").onclick = ()=>{
  if(!localStream) return;
  isMuted=!isMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  $("muteBtn").textContent = isMuted ? "üîä Unmute" : "üîá Mute";
  $("micState").textContent = isMuted ? "Mic: muted" : "Mic: on";
};

$("skipBtn").onclick = async ()=>{
  try{
    if(roomId){
      await room(roomId).update({endedBy:uid});
      await db.ref("signal/"+roomId).remove().catch(()=>{});
    }
  }catch(e){}
  setStatus("‚è≠ Skip qilindi. Yana Find bosing.");
  resetAll(false);
};

$("stopBtn").onclick = ()=>{
  setStatus("‚õî To‚Äòxtatildi.");
  resetAll(true);
};

function resetAll(fullStop){
  stopLoops();
  offAll();

  if(level) db.ref(`queue/${level}/${uid}`).remove().catch(()=>{});
  closePeer();

  if(fullStop) stopMic();

  searching=false; roomId=null; peerId=null;

  $("chatBox").innerHTML="";
  $("chatInput").disabled=true;
  $("sendBtn").disabled=true;
  $("chatInfo").textContent="Room kerak";

  $("callTag").textContent="Idle";
  $("peerTag").textContent="‚Äî";
  $("roomTag").textContent="‚Äî";

  if(level) setStatus(`‚úÖ Tayyor. Level: <b>${level}</b>. ‚ÄúFind Partner‚Äù bosing.`);
  else setStatus("Level tanlang. Keyin ‚ÄúFind Partner‚Äù.");
}
</script>
</body>
</html>
