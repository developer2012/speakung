<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Speaking Match ‚Äî Voice (Audio) + Skip</title>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg1:#08121c; --bg2:#0b2a3a;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --a:#00f2fe; --b:#4facfe;
      --ok:#26e6a7; --bad:#ff5a7a; --warn:#ffcf5a;
      --r:18px;
      --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box; margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 20% 10%, #123a55 0%, transparent 55%),
        radial-gradient(900px 600px at 80% 15%, #1a2f6b 0%, transparent 52%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--txt);
      display:flex; justify-content:center; align-items:center;
      padding:16px;
    }
    .app{
      width:min(1100px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }
    .brand{display:flex; align-items:center; gap:12px; user-select:none}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background:linear-gradient(135deg,var(--a),var(--b));
      display:grid; place-items:center;
      font-weight:900; color:#001018;
      box-shadow:0 12px 30px rgba(79,172,254,.20);
      cursor:pointer;
    }
    .brand h1{font-size:16px; line-height:1.1}
    .brand p{font-size:12px; color:var(--muted)}
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%; background:var(--warn); box-shadow:0 0 0 6px rgba(255,207,90,.14)}
    .dot.on{background:var(--ok); box-shadow:0 0 0 6px rgba(38,230,167,.14)}

    .content{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      padding:14px;
    }
    @media(max-width: 980px){
      .content{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r);
      padding:14px;
    }
    .card h2{
      font-size:13px;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .small{font-size:12px; color:var(--muted); line-height:1.45}

    .levels{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width: 430px){
      .levels{grid-template-columns: repeat(3, 1fr)}
    }
    .level{
      padding:12px 0;
      border-radius:14px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      text-align:center;
      font-weight:800;
      cursor:pointer;
      transition:.2s;
    }
    .level:hover{transform:translateY(-2px); background:rgba(255,255,255,.11)}
    .level.active{
      background:linear-gradient(135deg,var(--a),var(--b));
      color:#001018;
      border-color:transparent;
    }

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:none;
      cursor:pointer;
      border-radius:16px;
      padding:12px 14px;
      font-weight:900;
      font-size:14px;
      transition:.2s;
      display:flex; align-items:center; gap:10px;
    }
    .primary{background:linear-gradient(135deg,var(--a),var(--b)); color:#001018}
    .primary:hover{transform:scale(1.03)}
    .ghost{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); color:var(--txt)}
    .ghost:hover{background:rgba(255,255,255,.12)}
    .danger{background:rgba(255,90,122,.14); border:1px solid rgba(255,90,122,.35); color:#ffd7df}
    .danger:hover{background:rgba(255,90,122,.20)}

    .status{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }

    .stage{
      display:grid;
      grid-template-rows:auto auto 1fr;
      gap:12px;
      min-height:520px;
    }
    .tags{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .tag{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);
    }
    .tag b{color:#fff}
    .panel{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:12px;
    }
    .panel h3{
      font-size:13px;
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .meter{
      flex:1;
      min-width:220px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar{
      height:100%;
      width:0%;
      background:linear-gradient(90deg,var(--a),var(--b));
      transition:width .2s;
    }
    audio{width:100%}

    .hidden{display:none !important;}
  </style>
</head>
<body>

<div class="app">
  <div class="top">
    <div class="brand" id="brand">
      <div class="logo" id="logo">SZ</div>
      <div>
        <h1>Speaking Match ‚Äî Voice</h1>
        <p>Level tanlang ‚Üí Voice chat ‚Üí Skip</p>
      </div>
    </div>

    <div class="pill">
      <span class="dot" id="dot"></span>
      <span id="netText">Offline</span>
      <span id="adminOnline" class="hidden">‚Ä¢ Online: <b id="onlineCount">0</b></span>
    </div>
  </div>

  <div class="content">
    <!-- LEFT -->
    <div class="card">
      <h2>1) Level tanlang <span class="small" id="picked">‚Äî</span></h2>
      <div class="small">A1‚ÄìC2 tanlang. ‚ÄúFind Partner‚Äù bosilganda real online odam bilan juftlaydi (voice).</div>

      <div class="levels" id="levels">
        <div class="level">A1</div><div class="level">A2</div><div class="level">B1</div>
        <div class="level">B2</div><div class="level">C1</div><div class="level">C2</div>
      </div>

      <div class="btns">
        <button class="primary" id="findBtn">üîç Find Partner</button>
        <button class="ghost" id="muteBtn" disabled>üîá Mute</button>
        <button class="danger" id="skipBtn" disabled>‚è≠ Skip</button>
        <button class="danger" id="stopBtn">‚õî Stop</button>
      </div>

      <div class="status" id="status">
        Level tanlang. Keyin ‚ÄúFind Partner‚Äù.<br><br>
        <b>Admin panel:</b> Logo (SZ) ustiga 5 marta bos ‚Üí kod kirit ‚Üí online count faqat senga ko‚Äòrinadi.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="stage card">
      <div class="tags">
        <div class="tag">Level: <b id="levelTag">‚Äî</b></div>
        <div class="tag">Room: <b id="roomTag">‚Äî</b></div>
        <div class="tag">Status: <b id="callTag">Idle</b></div>
      </div>

      <div class="panel">
        <h3>
          üéß Voice Call (Audio-only)
          <span class="small" id="peerTag">partner: ‚Äî</span>
        </h3>

        <div class="row">
          <div class="meter"><div class="bar" id="micBar"></div></div>
          <div class="small" id="micState">Mic: off</div>
        </div>

        <div style="height:10px"></div>

        <audio id="remoteAudio" autoplay playsinline></audio>
        <div class="small" style="margin-top:8px;opacity:.8">
          Video yo‚Äòq ‚Äî faqat voice. (Sening so‚Äòrovingga ko‚Äòra)
        </div>
      </div>

      <div class="panel">
        <h3>üí¨ Matn (ixtiyoriy)</h3>
        <div class="small">Voice ishlamasa ham, xohlasang yozish funksiyasini keyin qo‚Äòshamiz (hozir voice fokus).</div>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================
 *  0) Firebase config
 *  ========================= */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/** =========================
 *  1) State
 *  ========================= */
const $ = (id)=>document.getElementById(id);

let uid = "u_" + Math.random().toString(36).slice(2);
let level = null;
let searching = false;
let roomId = null;
let peerId = null;

let localStream = null;
let pc = null;
let isMuted = false;

let unsub = []; // functions to detach listeners

function setStatus(html){ $('status').innerHTML = html; }
function setNet(online){
  $('dot').classList.toggle('on', !!online);
  $('netText').textContent = online ? "Online" : "Offline";
}

/** =========================
 *  2) Presence (online count)
 *  ========================= */
function setupPresence(){
  const connectedRef = db.ref(".info/connected");
  connectedRef.on("value", (snap) => {
    const isConn = snap.val() === true;
    setNet(isConn);

    if(isConn){
      const meRef = db.ref("presence/" + uid);
      meRef.onDisconnect().remove();
      meRef.set({ ts: Date.now(), level: level || "‚Äî" });
      // heartbeat
      const t = setInterval(()=> meRef.update({ ts: Date.now(), level: level || "‚Äî" }), 15000);
      unsub.push(()=> clearInterval(t));
    }
  });

  // Admin-only online count view (hidden by default)
  const adminEnabled = localStorage.getItem("admin_view") === "1";
  if(adminEnabled){
    $('adminOnline').classList.remove('hidden');
    db.ref("presence").on("value", (snap)=>{
      const v = snap.val() || {};
      $('onlineCount').textContent = Object.keys(v).length;
    });
  }
}
setupPresence();

/** Admin unlock: logo 5 clicks -> code */
let clickCount = 0;
$('logo').addEventListener('click', ()=>{
  clickCount++;
  if(clickCount >= 5){
    clickCount = 0;
    const code = prompt("Admin kod?");
    if(code === "2332"){ // xohlasang o'zgartirasan
      localStorage.setItem("admin_view","1");
      location.reload();
    } else {
      alert("Noto‚Äòg‚Äòri kod");
    }
  }
});

/** =========================
 *  3) UI: level select
 *  ========================= */
document.querySelectorAll('.level').forEach(el=>{
  el.addEventListener('click', ()=>{
    document.querySelectorAll('.level').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    level = el.textContent.trim();
    $('picked').textContent = level;
    $('levelTag').textContent = level;

    // update presence level immediately
    db.ref("presence/"+uid).update({ level });

    setStatus(`‚úÖ Level: <b>${level}</b>. Endi ‚ÄúFind Partner‚Äù bosing (voice).`);
  });
});

/** =========================
 *  4) WebRTC (Audio-only)
 *  ========================= */
const rtcConfig = {
  iceServers: [
    { urls: "stun:stun.l.google.com:19302" },
    { urls: "stun:stun1.l.google.com:19302" }
  ]
};

async function startMic(){
  if(localStream) return localStream;
  localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
  $('micState').textContent = "Mic: on";
  monitorMic(localStream);
  return localStream;
}

function stopMic(){
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
  }
  $('micState').textContent = "Mic: off";
  $('micBar').style.width = "0%";
}

function monitorMic(stream){
  // tiny mic meter (browser-native)
  try{
    const ac = new (window.AudioContext || window.webkitAudioContext)();
    const src = ac.createMediaStreamSource(stream);
    const analyser = ac.createAnalyser();
    analyser.fftSize = 256;
    src.connect(analyser);
    const data = new Uint8Array(analyser.frequencyBinCount);

    let alive = true;
    unsub.push(()=>{ alive=false; try{ac.close()}catch(e){} });

    const loop = ()=>{
      if(!alive) return;
      analyser.getByteFrequencyData(data);
      let sum=0;
      for(let i=0;i<data.length;i++) sum += data[i];
      const avg = sum / data.length; // 0..255
      const pct = Math.min(100, Math.max(0, (avg/255)*120));
      $('micBar').style.width = pct.toFixed(0) + "%";
      requestAnimationFrame(loop);
    };
    loop();
  }catch(e){
    // ignore meter errors
  }
}

function closePeer(){
  if(pc){
    try{ pc.onicecandidate = null; pc.ontrack = null; pc.onconnectionstatechange=null; pc.close(); }catch(e){}
    pc = null;
  }
  $('remoteAudio').srcObject = null;
  $('callTag').textContent = "Idle";
  $('peerTag').textContent = "partner: ‚Äî";
  $('roomTag').textContent = "‚Äî";
  $('muteBtn').disabled = true;
  $('skipBtn').disabled = true;
  isMuted = false;
  $('muteBtn').textContent = "üîá Mute";
}

async function initPeerConnection(){
  pc = new RTCPeerConnection(rtcConfig);

  const stream = await startMic();
  stream.getTracks().forEach(t=> pc.addTrack(t, stream));

  pc.ontrack = (evt)=>{
    $('remoteAudio').srcObject = evt.streams[0];
  };

  pc.onconnectionstatechange = ()=>{
    if(!pc) return;
    $('callTag').textContent = pc.connectionState;
    if(["disconnected","failed","closed"].includes(pc.connectionState)){
      // if disconnected, return to lobby
    }
  };
}

/** Signaling via Firebase */
function signalRef(room){ return db.ref("signal/"+room); }

async function becomeCaller(){
  await initPeerConnection();

  const sig = signalRef(roomId);
  const myCandRef = sig.child("candidates").child(uid);

  pc.onicecandidate = (e)=>{
    if(e.candidate) myCandRef.push(e.candidate.toJSON());
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await sig.child("offer").set({ sdp: offer.sdp, type: offer.type, from: uid });

  // wait answer
  const ansCb = sig.child("answer");
  ansCb.on("value", async (snap)=>{
    const a = snap.val();
    if(a && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(a));
    }
  });
  unsub.push(()=> ansCb.off());

  // listen peer candidates
  const peerCand = sig.child("candidates").child(peerId);
  peerCand.on("child_added", async (snap)=>{
    const c = snap.val();
    if(pc && c) {
      try{ await pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){}
    }
  });
  unsub.push(()=> peerCand.off());
}

async function becomeCallee(){
  await initPeerConnection();

  const sig = signalRef(roomId);
  const myCandRef = sig.child("candidates").child(uid);

  pc.onicecandidate = (e)=>{
    if(e.candidate) myCandRef.push(e.candidate.toJSON());
  };

  // wait offer
  const offRef = sig.child("offer");
  offRef.on("value", async (snap)=>{
    const o = snap.val();
    if(!o || !pc) return;
    if(!pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(o));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await sig.child("answer").set({ sdp: answer.sdp, type: answer.type, from: uid });
    }
  });
  unsub.push(()=> offRef.off());

  // listen peer candidates
  const peerCand = sig.child("candidates").child(peerId);
  peerCand.on("child_added", async (snap)=>{
    const c = snap.val();
    if(pc && c){
      try{ await pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){}
    }
  });
  unsub.push(()=> peerCand.off());
}

/** =========================
 *  5) Matchmaking (client-side claim)
 *  ========================= */
function queueRef(){ return db.ref("queue/"+level); }
function roomRef(id){ return db.ref("rooms/"+id); }

async function findPartner(){
  if(!level) return alert("Avval level tanlang!");
  if(searching) return;

  searching = true;
  setStatus(`üîé <b>${level}</b> partner qidirilyapti...`);
  $('callTag').textContent = "Searching";
  $('muteBtn').disabled = true;
  $('skipBtn').disabled = false;

  // Put self in queue
  const meQ = db.ref(`queue/${level}/${uid}`);
  await meQ.set({ ts: Date.now(), claimedBy: null, matchedRoom: null });
  meQ.onDisconnect().remove();

  // Listen for my matchedRoom
  meQ.child("matchedRoom").on("value", async (snap)=>{
    const r = snap.val();
    if(r && searching){
      roomId = r;
      await joinRoomAndStart();
    }
  });
  unsub.push(()=> meQ.child("matchedRoom").off());

  // Try to claim someone else
  // Fetch oldest 20
  const snap = await queueRef().orderByChild("ts").limitToFirst(20).once("value");
  const list = snap.val() || {};
  const ids = Object.keys(list).filter(id => id !== uid);

  for(const otherId of ids){
    const node = list[otherId];
    if(!node || node.matchedRoom) continue;

    const claimNode = db.ref(`queue/${level}/${otherId}/claimedBy`);
    const res = await claimNode.transaction((cur)=>{
      if(cur === null) return uid; // claim
      return; // abort
    });

    if(res.committed){
      // I am caller, create room
      const a = [uid, otherId].sort();
      roomId = `r_${level}_${a[0]}_${a[1]}`;
      peerId = otherId;

      // write room users
      await roomRef(roomId).set({
        level,
        createdAt: Date.now(),
        users: { [uid]: true, [otherId]: true },
        endedBy: null
      });

      // set matchedRoom for both
      const updates = {};
      updates[`queue/${level}/${uid}/matchedRoom`] = roomId;
      updates[`queue/${level}/${otherId}/matchedRoom`] = roomId;
      await db.ref().update(updates);

      break;
    }
  }
}

async function joinRoomAndStart(){
  if(!roomId) return;
  searching = false;

  $('roomTag').textContent = roomId;
  $('callTag').textContent = "Connecting";

  // Load room to get peerId
  const rSnap = await roomRef(roomId).once("value");
  const r = rSnap.val();
  if(!r || !r.users){
    setStatus("‚ùå Room topilmadi. Qayta urinib ko‚Äòring.");
    return resetAll();
  }

  const users = Object.keys(r.users);
  peerId = users.find(x=>x!==uid) || null;

  $('peerTag').textContent = "partner: " + (peerId ? peerId.slice(0,8) : "‚Äî");
  setStatus(`‚úÖ Ulandi. Voice chat boshlanyapti...`);
  $('muteBtn').disabled = false;
  $('skipBtn').disabled = false;

  // Stop queue entries (cleanup)
  db.ref(`queue/${level}/${uid}`).remove();
  if(peerId) db.ref(`queue/${level}/${peerId}`).remove();

  // Listen endedBy (skip)
  const endedRef = roomRef(roomId).child("endedBy");
  endedRef.on("value", (snap)=>{
    const v = snap.val(); 
    if(v && v !== uid){
      setStatus("‚õî Partner chiqib ketdi (skip). Yana qidiring.");
      resetAll();
    }
  });
  unsub.push(()=> endedRef.off());

  // Decide caller/callee: smallest uid becomes caller (stable)
  const caller = [uid, peerId].sort()[0] === uid;

  try{
    if(caller){
      $('callTag').textContent = "Caller";
      await becomeCaller();
    } else {
      $('callTag').textContent = "Callee";
      await becomeCallee();
    }
    setStatus("üéß Voice chat tayyor. Gaplashishingiz mumkin.");
  }catch(e){
    setStatus("‚ùå Voice ulanishda xatolik. Skip bosing va qayta urinib ko‚Äòring.");
  }
}

/** =========================
 *  6) Buttons: Find / Mute / Skip / Stop
 *  ========================= */
$('findBtn').addEventListener('click', async ()=>{
  try{
    await findPartner();
  }catch(e){
    setStatus("‚ùå Qidirishda xatolik. Qayta urinib ko‚Äòring.");
  }
});

$('muteBtn').addEventListener('click', ()=>{
  if(!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t=> t.enabled = !isMuted);
  $('muteBtn').textContent = isMuted ? "üîä Unmute" : "üîá Mute";
  $('micState').textContent = isMuted ? "Mic: muted" : "Mic: on";
});

$('skipBtn').addEventListener('click', async ()=>{
  // End room for both
  try{
    if(roomId){
      await roomRef(roomId).update({ endedBy: uid });
      // Optional cleanup signaling
      await db.ref("signal/"+roomId).remove();
    }
  }catch(e){}
  setStatus("‚è≠ Skip qilindi. Yana qidirishingiz mumkin.");
  resetAll();
});

$('stopBtn').addEventListener('click', ()=>{
  setStatus("‚õî To‚Äòxtatildi.");
  resetAll(true);
});

/** =========================
 *  7) Cleanup
 *  ========================= */
function detachAll(){
  for(const f of unsub){
    try{ f(); }catch(e){}
  }
  unsub = [];
}

function resetAll(fullStop=false){
  detachAll();

  // remove queue if any
  if(level){
    db.ref(`queue/${level}/${uid}`).remove().catch(()=>{});
  }

  // close peer
  closePeer();

  // stop mic if full stop
  if(fullStop){
    stopMic();
  }

  searching = false;
  roomId = null;
  peerId = null;

  $('roomTag').textContent = "‚Äî";
  $('callTag').textContent = "Idle";
  $('peerTag').textContent = "partner: ‚Äî";

  $('muteBtn').disabled = true;
  $('skipBtn').disabled = true;

  if(level){
    setStatus(`‚úÖ Tayyor. Level: <b>${level}</b>. ‚ÄúFind Partner‚Äù bosing.`);
  } else {
    setStatus("Level tanlang. Keyin ‚ÄúFind Partner‚Äù.");
  }
}
</script>
</body>
</html>
