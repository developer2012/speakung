<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fast Match ‚Äî Voice + Text</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg1:#07131f; --bg2:#0b2a3a;
      --card:rgba(255,255,255,.08);
      --stroke:rgba(255,255,255,.14);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.70);
      --a:#00f2fe; --b:#4facfe;
      --ok:#26e6a7; --bad:#ff5a7a; --warn:#ffcf5a;
      --r:18px; --shadow:0 18px 60px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 20% 10%, #123a55 0%, transparent 55%),
        radial-gradient(900px 600px at 80% 15%, #1a2f6b 0%, transparent 52%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--txt);
      display:flex;justify-content:center;align-items:center;
      padding:14px;
    }
    .app{
      width:min(1120px,100%);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }
    .brand{display:flex;align-items:center;gap:12px;user-select:none}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:linear-gradient(135deg,var(--a),var(--b));
      display:grid;place-items:center;
      font-weight:900;color:#001018;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(79,172,254,.20);
    }
    .brand h1{font-size:16px;line-height:1.1}
    .brand p{font-size:12px;color:var(--muted)}
    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:var(--warn);box-shadow:0 0 0 6px rgba(255,207,90,.14)}
    .dot.on{background:var(--ok);box-shadow:0 0 0 6px rgba(38,230,167,.14)}
    .content{
      display:grid;
      grid-template-columns: 390px 1fr;
      gap:14px;
      padding:14px;
    }
    @media(max-width: 980px){ .content{grid-template-columns:1fr} }
    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.12);
      border-radius:var(--r);
      padding:14px;
    }
    .card h2{font-size:13px;display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .small{font-size:12px;color:var(--muted);line-height:1.45}
    .levels{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width: 430px){ .levels{grid-template-columns: repeat(3, 1fr)} }
    .level{
      padding:12px 0;border-radius:14px;
      background:rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      text-align:center;font-weight:900;
      cursor:pointer;transition:.2s;
    }
    .level:hover{transform:translateY(-2px);background:rgba(255,255,255,.11)}
    /* ‚úÖ level bosilganda ko‚Äòk bo‚Äòlsin */
    .level.active{
      background:#4facfe;
      color:#001018;
      border-color:transparent;
      box-shadow:0 12px 30px rgba(79,172,254,.22);
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:none;cursor:pointer;border-radius:16px;
      padding:12px 14px;font-weight:900;font-size:14px;
      transition:.2s;display:flex;align-items:center;gap:10px;
    }
    .primary{background:linear-gradient(135deg,var(--a),var(--b));color:#001018}
    .primary:hover{transform:scale(1.03)}
    .ghost{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:var(--txt)}
    .ghost:hover{background:rgba(255,255,255,.12)}
    .danger{background:rgba(255,90,122,.14);border:1px solid rgba(255,90,122,.35);color:#ffd7df}
    .danger:hover{background:rgba(255,90,122,.20)}
    .status{
      margin-top:12px;padding:12px;border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      font-size:12px;color:var(--muted);line-height:1.45;
    }
    .stage{
      display:grid;
      grid-template-rows:auto 1fr;
      gap:12px;
      min-height:560px;
    }
    .tags{display:flex;gap:10px;flex-wrap:wrap}
    .tag{
      font-size:12px;padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.85);
    }
    .tag b{color:#fff}
    .panels{display:grid;grid-template-columns: 1fr 1fr;gap:12px;}
    @media(max-width: 980px){ .stage{min-height:700px} .panels{grid-template-columns:1fr} }
    .panel{
      border-radius:18px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      padding:12px;
      display:flex;flex-direction:column;
      min-height: 320px;
    }
    .panel h3{font-size:13px;display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .meter{
      flex:1;min-width:220px;height:10px;border-radius:999px;
      background:rgba(255,255,255,.10);overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--a),var(--b));transition:width .2s}
    audio{width:100%}
    .chatBox{
      flex:1;overflow:auto;border-radius:14px;padding:10px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .msg{
      max-width:85%;margin:8px 0;padding:10px 12px;border-radius:14px;
      font-size:12px;line-height:1.35;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      white-space:pre-wrap;word-break:break-word;
    }
    .me{margin-left:auto;background:rgba(0,242,254,.10);border-color:rgba(0,242,254,.25)}
    .meta{opacity:.7;font-size:10px;margin-top:4px}
    .chatInputRow{display:flex;gap:10px;margin-top:10px}
    input[type="text"]{
      flex:1;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.55)}
    .sendBtn{
      padding:12px 14px;border-radius:14px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;font-weight:900;
    }
    .sendBtn:hover{background:rgba(255,255,255,.14)}
    .hidden{display:none !important;}

    /* ==========================
       ‚úÖ OPEN SCREEN (RASMDAGIDEK)
    =========================== */
    #openScreen{
      position:fixed;inset:0;
      display:grid;place-items:center;
      z-index:9999;
      padding:18px;
      background:
        radial-gradient(900px 600px at 15% 15%, #163f4f 0%, transparent 55%),
        radial-gradient(900px 600px at 85% 20%, #163a52 0%, transparent 52%),
        linear-gradient(135deg,#0b2430,#0f3746);
    }
    .openCard{
      width:min(560px, 100%);
      border-radius:28px;
      padding:26px 26px 24px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 18px 60px rgba(0,0,0,.45);
      text-align:center;
    }
    .openTitleRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:14px;
      margin-bottom:10px;
    }
    .openMic{
      font-size:28px;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,.35));
      transform: translateY(-1px);
    }
    .openTitle{
      font-size:40px;
      font-weight:1000;
      letter-spacing:.3px;
      line-height:1;
      text-shadow:0 8px 26px rgba(0,0,0,.35);
    }
    .openSub{
      margin-top:8px;
      font-size:14px;
      line-height:1.6;
      color:rgba(255,255,255,.82);
    }
    .openBtn{
      margin-top:18px;
      width:100%;
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:16px 18px;
      font-size:18px;
      font-weight:1000;
      color:#001018;
      background:linear-gradient(135deg,#16e9ff,#3aa8ff);
      box-shadow:0 18px 40px rgba(22,233,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:.18s;
    }
    .openBtn:hover{ transform:translateY(-1px); filter:brightness(1.03); }
    .openBtn:active{ transform:translateY(1px); }
  </style>
</head>

<body>

<!-- ‚úÖ OPEN (rasmdagidek) -->
<div id="openScreen">
  <div class="openCard">
    <div class="openTitleRow">
      <div class="openMic">üéôÔ∏è</div>
      <div class="openTitle">Fast Match</div>
    </div>

    <div class="openSub">
      Level tanlang ‚Üí Find ‚Üí Qidirilyapti ‚Üí Topildi ‚Üí<br>
      Gaplashish<br>
      Voice (audio-only) + Text bor.
    </div>

    <button class="openBtn" id="openBtn">üöÄ OPEN</button>
  </div>
</div>

<div class="app" id="mainApp" style="display:none;">
  <div class="top">
    <div class="brand">
      <div class="logo" id="logo">SZ</div>
      <div>
        <h1>Fast Match ‚Ä¢ Voice + Text</h1>
        <p>Find ‚Üí Qidirilyapti ‚Üí Topildi ‚Üí Gaplashish</p>
      </div>
    </div>
    <div class="pill">
      <span class="dot" id="dot"></span>
      <span id="netText">Ulanmoqda...</span>
      <!-- ‚úÖ SZ 5 marta bosilganda ko‚Äòrinadi -->
      <span id="adminOnline" class="hidden">‚Ä¢ Online: <b id="onlineCount">0</b></span>
    </div>
  </div>

  <div class="content">
    <div class="card">
      <h2>1) Level tanlang <span class="small" id="picked">‚Äî</span></h2>
      <div class="small">Bir xil leveldagi online odam bo‚Äòlsa tezda topadi. Yo‚Äòq bo‚Äòlsa qidirishda turadi.</div>

      <div class="levels">
        <div class="level">A1</div><div class="level">A2</div><div class="level">B1</div>
        <div class="level">B2</div><div class="level">C1</div><div class="level">C2</div>
      </div>

      <div class="btns">
        <button class="primary" id="findBtn">üîç Find Partner</button>
        <button class="ghost" id="muteBtn" disabled>üîá Mute</button>
        <button class="danger" id="skipBtn" disabled>‚è≠ Skip</button>
        <button class="danger" id="stopBtn">‚õî Stop</button>
      </div>

      <div class="status" id="status">Level tanlang. Keyin ‚ÄúFind Partner‚Äù.</div>
    </div>

    <div class="stage card">
      <div class="tags">
        <div class="tag">Level: <b id="levelTag">‚Äî</b></div>
        <div class="tag">Room: <b id="roomTag">‚Äî</b></div>
        <div class="tag">Status: <b id="callTag">Idle</b></div>
        <div class="tag">Partner: <b id="peerTag">‚Äî</b></div>
      </div>

      <div class="panels">
        <div class="panel">
          <h3>üéß Voice (Audio-only) <span class="small" id="micState">Mic: off</span></h3>
          <div class="row"><div class="meter"><div class="bar" id="micBar"></div></div></div>
          <div style="height:10px"></div>
          <audio id="remoteAudio" autoplay playsinline></audio>
          <div class="small" style="margin-top:8px;opacity:.8">Topilganda avtomatik voice boshlanadi.</div>
        </div>

        <div class="panel">
          <h3>üí¨ Text Chat <span class="small" id="chatInfo">Room kerak</span></h3>
          <div class="chatBox" id="chatBox"></div>
          <div class="chatInputRow">
            <input id="chatInput" type="text" placeholder="Xabar yozing..." disabled />
            <button class="sendBtn" id="sendBtn" disabled>Send</button>
          </div>
          <div class="small" style="margin-top:8px;opacity:.8">Gaplashishni xohlamaganlar shu yerda yozishadi.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =======================
   SUPABASE CONFIG
======================= */
const SUPABASE_URL = "https://snqkwdwoxtbkaqfhehxq.supabase.co";
const SUPABASE_KEY = "sb_publishable_ehiDOw8qEeUw4lr--7uMJw_px5GvlSR";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =======================
   UI OPEN
======================= */
const openBtn = document.getElementById("openBtn");
const openScreen = document.getElementById("openScreen");
const mainApp = document.getElementById("mainApp");
openBtn.onclick = () => { openScreen.style.display="none"; mainApp.style.display="block"; };

/* =======================
   HELPERS
======================= */
const $ = (id)=>document.getElementById(id);
const esc = (s)=> (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
const nowTime = ()=> new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
function setStatus(html){ $("status").innerHTML = html; }
function addMsg(text, who){
  const box = $("chatBox");
  const d = document.createElement("div");
  d.className = "msg" + (who==="me" ? " me" : "");
  d.innerHTML = `<div>${esc(text)}</div><div class="meta">${who==="me"?"You":"Partner"} ‚Ä¢ ${nowTime()}</div>`;
  box.appendChild(d);
  box.scrollTop = box.scrollHeight;
}

/* =======================
   STATE
======================= */
const uid = "u_" + Math.random().toString(36).slice(2);
let level = null;

let onlineChan = null;
let levelChan = null;
let roomChan = null;

let roomId = null;
let peerId = null;

let searching = false;
let findPulse = null;

/* voice */
let pc = null;
let localStream = null;
let isMuted = false;
const rtcConfig = { iceServers:[
  {urls:"stun:stun.l.google.com:19302"},
  {urls:"stun:stun1.l.google.com:19302"}
] };

/* =======================
   ‚úÖ SZ 5x BOSSA ONLINE COUNT KO‚ÄòRINADI
======================= */
let showOnline = (localStorage.getItem("show_online")==="1");
let logoClicks = 0;
let logoWindowUntil = 0;

function refreshOnlineUI(){
  if(showOnline){
    $("adminOnline").classList.remove("hidden");
  } else {
    $("adminOnline").classList.add("hidden");
  }
}
refreshOnlineUI();

$("logo").addEventListener("click", ()=>{
  const now = Date.now();
  if(now > logoWindowUntil){
    logoClicks = 0;
    logoWindowUntil = now + 2500; // 2.5s ichida 5 marta
  }
  logoClicks++;
  if(logoClicks >= 5){
    logoClicks = 0;
    showOnline = !showOnline;
    localStorage.setItem("show_online", showOnline ? "1" : "0");
    refreshOnlineUI();
  }
});

/* =======================
   ONLINE PRESENCE (global)
======================= */
async function startOnlinePresence(){
  if(onlineChan) await supabase.removeChannel(onlineChan);

  onlineChan = supabase.channel("online-global", {
    config: { presence: { key: uid } }
  });

  const setOnlineUI = (ok)=>{
    $("dot").classList.toggle("on", !!ok);
    $("netText").textContent = ok ? "Online" : "Ulanmadi";
  };

  const updateCount = ()=>{
    const state = onlineChan.presenceState();
    $("onlineCount").textContent = String(Object.keys(state).length);
  };

  onlineChan.on("presence", { event:"sync" }, ()=>{
    setOnlineUI(true);
    updateCount();
  });

  onlineChan.on("presence", { event:"join" }, ()=>{
    updateCount();
  });

  onlineChan.on("presence", { event:"leave" }, ()=>{
    updateCount();
  });

  onlineChan.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      setOnlineUI(true);
      await onlineChan.track({ uid, ts: Date.now() });
    } else if(status === "CHANNEL_ERROR" || status === "TIMED_OUT"){
      setOnlineUI(false);
      setStatus("‚ùå Supabase Realtime ulanmagan. Supabase ‚Üí Realtime yoqilganini tekshir.");
    }
  });
}
startOnlinePresence();

/* =======================
   LEVEL SELECT
======================= */
document.querySelectorAll(".level").forEach(el=>{
  el.addEventListener("click", ()=>{
    document.querySelectorAll(".level").forEach(x=>x.classList.remove("active"));
    el.classList.add("active");
    level = el.textContent.trim();
    $("picked").textContent = level;
    $("levelTag").textContent = level;
    setStatus(`‚úÖ Level: <b>${level}</b>. Endi ‚ÄúFind Partner‚Äù bosing.`);
  });
});

/* =======================
   MATCHMAKING (same level)
   - looking -> proposal -> accept -> enter room
======================= */
async function joinLevelChannel(){
  if(!level) return;
  if(levelChan) await supabase.removeChannel(levelChan);

  levelChan = supabase.channel("lvl-"+level, { config:{ presence:{ key: uid } } });

  levelChan.on("broadcast", { event:"looking" }, (payload)=>{
    const from = payload?.payload?.from;
    if(!from || from === uid) return;
    if(!searching || roomId) return;

    // deterministic: kichik uid taklif qiladi
    if(uid < from){
      const a = [uid, from].sort();
      const proposedRoom = `r_${level}_${a[0]}_${a[1]}`;
      levelChan.send({
        type:"broadcast",
        event:"proposal",
        payload:{ to: from, from: uid, roomId: proposedRoom }
      });
    }
  });

  levelChan.on("broadcast", { event:"proposal" }, async (payload)=>{
    const p = payload?.payload;
    if(!p || p.to !== uid) return;
    if(!searching || roomId) return;

    roomId = p.roomId;
    peerId = p.from;

    setStatus(`‚úÖ <b>Topildi!</b> Ulanmoqda...`);
    $("callTag").textContent = "Connecting";

    await levelChan.send({ type:"broadcast", event:"accept", payload:{ to: peerId, from: uid, roomId } });
    await enterRoom(roomId, peerId);
  });

  levelChan.on("broadcast", { event:"accept" }, async (payload)=>{
    const p = payload?.payload;
    if(!p || p.to !== uid) return;
    if(!searching || roomId) return;

    roomId = p.roomId;
    peerId = p.from;

    setStatus(`‚úÖ <b>Topildi!</b> Ulanmoqda...`);
    $("callTag").textContent = "Connecting";

    await enterRoom(roomId, peerId);
  });

  await levelChan.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      await levelChan.track({ uid, level, searching:false, ts:Date.now() });
    }
  });
}

async function startFinding(){
  if(!level) return alert("Level tanlang!");
  if(searching) return;

  searching = true;
  $("chatBox").innerHTML="";
  $("chatInfo").textContent="Qidirilyapti...";
  $("callTag").textContent="Searching";
  setStatus(`üîé <b>${level}</b> uchun <b>qidirilyapti...</b>`);

  await joinLevelChannel();
  if(levelChan) await levelChan.track({ uid, level, searching:true, ts:Date.now() });

  if(findPulse) clearInterval(findPulse);
  findPulse = setInterval(()=>{
    if(!levelChan || !searching || roomId) return;
    levelChan.send({ type:"broadcast", event:"looking", payload:{ from: uid, ts: Date.now() } });
  }, 650);

  $("skipBtn").disabled = false;
}

async function stopFindingOnly(){
  searching = false;
  if(findPulse){ clearInterval(findPulse); findPulse=null; }
  if(levelChan){
    try{ await levelChan.track({ uid, level, searching:false, ts:Date.now() }); }catch(e){}
  }
  $("callTag").textContent="Idle";
  $("chatInfo").textContent="Room kerak";
  $("skipBtn").disabled = true;
}

/* =======================
   ROOM: text + signaling
======================= */
async function enterRoom(rid, pid){
  searching = false;
  if(findPulse){ clearInterval(findPulse); findPulse=null; }

  $("roomTag").textContent = rid;
  $("peerTag").textContent = pid ? pid.slice(0,8) : "‚Äî";
  $("chatInfo").textContent = "Ulandi";
  $("chatInput").disabled = false;
  $("sendBtn").disabled = false;
  $("muteBtn").disabled = false;
  $("skipBtn").disabled = false;

  if(roomChan) await supabase.removeChannel(roomChan);
  roomChan = supabase.channel("room-"+rid);

  // chat
  roomChan.on("broadcast", { event:"chat" }, (payload)=>{
    const p = payload?.payload;
    if(!p || !p.text) return;
    addMsg(p.text, (p.from===uid) ? "me" : "peer");
  });

  // end
  roomChan.on("broadcast", { event:"end" }, (payload)=>{
    const p = payload?.payload;
    if(p?.from && p.from !== uid){
      setStatus("‚õî Partner skip qildi. Yana Find bosing.");
      resetAll(false);
    }
  });

  // signaling
  roomChan.on("broadcast", { event:"offer" }, async (payload)=>{
    const p = payload?.payload;
    if(!p || p.to !== uid) return;
    await ensurePC(pid);
    await pc.setRemoteDescription(new RTCSessionDescription(p.desc));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    roomChan.send({ type:"broadcast", event:"answer", payload:{ to: pid, from: uid, desc: pc.localDescription } });
  });

  roomChan.on("broadcast", { event:"answer" }, async (payload)=>{
    const p = payload?.payload;
    if(!p || p.to !== uid) return;
    if(!pc) return;
    if(!pc.currentRemoteDescription){
      await pc.setRemoteDescription(new RTCSessionDescription(p.desc));
    }
  });

  roomChan.on("broadcast", { event:"candidate" }, async (payload)=>{
    const p = payload?.payload;
    if(!p || p.to !== uid) return;
    if(!pc) return;
    try{ await pc.addIceCandidate(new RTCIceCandidate(p.cand)); }catch(e){}
  });

  await roomChan.subscribe(async (status)=>{
    if(status === "SUBSCRIBED"){
      setStatus("‚úÖ <b>Topildi!</b> üéß <b>Gaplashishni boshlang</b> (voice tayyor).");
      $("callTag").textContent="Connected";

      // deterministic caller
      if(uid < pid){
        await ensurePC(pid);
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        roomChan.send({ type:"broadcast", event:"offer", payload:{ to: pid, from: uid, desc: pc.localDescription } });
      }
    }
  });
}

/* =======================
   VOICE: audio only
======================= */
async function ensurePC(pid){
  if(pc) return;
  pc = new RTCPeerConnection(rtcConfig);

  if(!localStream){
    localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
    $("micState").textContent = "Mic: on";
    monitorMic(localStream);
  }
  localStream.getTracks().forEach(t=> pc.addTrack(t, localStream));

  pc.ontrack = (e)=> { $("remoteAudio").srcObject = e.streams[0]; };

  pc.onicecandidate = (e)=>{
    if(e.candidate && roomChan){
      roomChan.send({ type:"broadcast", event:"candidate", payload:{ to: pid, from: uid, cand: e.candidate.toJSON() } });
    }
  };
}

function monitorMic(stream){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const src = ac.createMediaStreamSource(stream);
    const an = ac.createAnalyser();
    an.fftSize=256; src.connect(an);
    const data = new Uint8Array(an.frequencyBinCount);
    const loop=()=>{
      if(!localStream) return;
      an.getByteFrequencyData(data);
      let sum=0; for(let i=0;i<data.length;i++) sum+=data[i];
      const avg=sum/data.length;
      const pct=Math.min(100, Math.max(0, (avg/255)*120));
      $("micBar").style.width = pct.toFixed(0)+"%";
      requestAnimationFrame(loop);
    };
    loop();
  }catch(e){}
}

/* =======================
   BUTTONS
======================= */
$("findBtn").onclick = startFinding;

$("sendBtn").onclick = ()=>{
  const v = $("chatInput").value.trim();
  if(!v || !roomChan) return;
  $("chatInput").value = "";
  roomChan.send({ type:"broadcast", event:"chat", payload:{ from: uid, text: v, ts: Date.now() } });
};
$("chatInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") $("sendBtn").click(); });

$("muteBtn").onclick = ()=>{
  if(!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t=> t.enabled = !isMuted);
  $("muteBtn").textContent = isMuted ? "üîä Unmute" : "üîá Mute";
  $("micState").textContent = isMuted ? "Mic: muted" : "Mic: on";
};

$("skipBtn").onclick = async ()=>{
  if(roomChan && roomId){
    roomChan.send({ type:"broadcast", event:"end", payload:{ from: uid, roomId } });
  }
  setStatus("‚è≠ Skip qilindi. Yana Find bosing.");
  resetAll(false);
};

$("stopBtn").onclick = ()=>{
  setStatus("‚õî To‚Äòxtatildi.");
  resetAll(true);
};

/* =======================
   RESET
======================= */
async function resetAll(fullStop){
  await stopFindingOnly();

  if(roomChan){
    await supabase.removeChannel(roomChan);
    roomChan = null;
  }
  roomId = null;
  peerId = null;

  if(pc){ try{ pc.close(); }catch(e){} pc=null; }
  $("remoteAudio").srcObject = null;

  if(fullStop && localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
    $("micState").textContent="Mic: off";
    $("micBar").style.width="0%";
  }

  $("roomTag").textContent="‚Äî";
  $("peerTag").textContent="‚Äî";
  $("callTag").textContent="Idle";
  $("chatInfo").textContent="Room kerak";
  $("chatBox").innerHTML="";
  $("chatInput").disabled=true;
  $("sendBtn").disabled=true;
  $("muteBtn").disabled=true;
  $("skipBtn").disabled=true;
  isMuted=false;
  $("muteBtn").textContent="üîá Mute";

  if(level) setStatus(`‚úÖ Tayyor. Level: <b>${level}</b>. ‚ÄúFind Partner‚Äù bosing.`);
  else setStatus("Level tanlang. Keyin ‚ÄúFind Partner‚Äù.");
}
</script>
</body>
</html>
